<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Empenhos e Contratos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <div class="container">
        <h1>Consulta de Empenhos e Contratos</h1>

        <form id="formEmpenho">
            <label for="anoEmpenho">Ano do Empenho:</label>
            <input type="number" id="anoEmpenho" name="anoEmpenho" placeholder="Ex: 2023" required>

            <label for="codorgao">Código do Órgão:</label>
            <input type="number" id="codorgao" name="codorgao" placeholder="Ex: 16" required>

            <button type="submit">Buscar Dados</button>
        </form>

        <div id="loading" style="display: none; margin-top: 20px;">
            <p>Carregando dados, por favor aguarde...</p>
            <div class="spinner"></div>
        </div>

        <div id="resultados-container" style="display: none;">
            <h2>Resultados por Empresa</h2>
            <div id="resumo-total"></div>
            <div id="graficos-container"></div>
        </div>

        <div id="error-container" style="display: none; color: red; margin-top: 20px;">
            <p id="error-message"></p>
        </div>
    </div>

    <!-- Modal para detalhes do contrato -->
    <div id="contrato-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Detalhes do Contrato</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // Armazenar dados de todos os contratos para usar no modal
            let dadosContratos = [];

            $("#formEmpenho").submit(function (e) {
                e.preventDefault();

                $("#loading").show();
                $("#resultados-container").hide();
                $("#error-container").hide();
                $("#graficos-container").empty();
                $("#resumo-total").empty();

                let anoEmpenho = $("#anoEmpenho").val();
                let codorgao = $("#codorgao").val();

                $.ajax({
                    url: "/buscar_dados",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        anoEmpenho: anoEmpenho,
                        codorgao: codorgao
                    }),
                    success: function (response) {
                        $("#loading").hide();

                        if (response.resultados && response.resultados.length > 0) {
                            // Armazenar dados para uso posterior
                            dadosContratos = response.resultados;

                            // Adaptar a estrutura de dados retornada pelo backend
                            response.resultados.forEach(empresa => {
                                // Renomear campos para compatibilidade com o frontend
                                empresa.contrato_valor = empresa.total_contratos;
                                // A diferença já está calculada no backend
                            });

                            // Mostrar resumo do total
                            const totalEmpresas = response.resultados.length;
                            const totalContratado = response.resultados.reduce((sum, emp) => sum + emp.contrato_valor, 0);
                            const totalEmpenhado = response.resultados.reduce((sum, emp) => sum + emp.total_empenhado, 0);

                            $("#resumo-total").html(`
                        <div class="resumo-box">
                            <p><strong>Total de contratos:</strong> ${totalEmpresas}</p>
                            <p><strong>Valor Total Contratado:</strong> R$ ${formatarValor(totalContratado)}</p>
                            <p><strong>Valor Total Empenhado:</strong> R$ ${formatarValor(totalEmpenhado)}</p>
                            <p><strong>Valor Total a Empenhar:</strong> R$ ${formatarValor(totalContratado - totalEmpenhado)}</p>
                        </div>
                    `);

                            exibirResultados(response.resultados);
                        } else {
                            $("#error-message").text("Nenhum dado encontrado para os critérios informados.");
                            $("#error-container").show();
                        }
                    },
                    error: function (xhr) {
                        $("#loading").hide();
                        let errorMsg = xhr.responseJSON?.error || "Ocorreu um erro na consulta.";
                        $("#error-message").text("Erro: " + errorMsg);
                        $("#error-container").show();
                    }
                });
            });

            function exibirResultados(empresas) {
                $("#resultados-container").show();

                // Ordenar empresas para gráfico de barras (por valor total decrescente)
                let empresasBarras = [...empresas].sort((a, b) => {
                    const totalA = a.total_empenhado + a.diferenca;
                    const totalB = b.total_empenhado + b.diferenca;
                    return totalB - totalA; // Ordem decrescente
                });

                // Criar gráfico comparativo geral (com dados ordenados)
                criarGraficoGeral(empresasBarras);

                // Ordenar empresas alfabeticamente para gráficos de pizza
                let empresasPizza = [...empresas].sort((a, b) => {
                    // Tratando valores nulos ou undefined
                    const nomeA = (a.empresa || "").toLowerCase();
                    const nomeB = (b.empresa || "").toLowerCase();
                    return nomeA.localeCompare(nomeB);
                });

                // Criar gráficos individuais para cada empresa (alfabeticamente)
                empresasPizza.forEach(function (empresa, index) {
                    criarGraficoEmpresa(empresa, index);
                });
            }

            function criarGraficoGeral(empresas) {
                let dadosGrafico = empresas;

                let empresasNomes = dadosGrafico.map(e => truncarTexto(e.empresa, 20));
                let valoresEmpenhados = dadosGrafico.map(e => e.total_empenhado);
                let valoresPendentes = dadosGrafico.map(e => e.diferenca);

                let divGrafico = document.createElement('div');
                divGrafico.id = 'grafico-geral';
                divGrafico.className = 'grafico-box';

                $("#graficos-container").append(divGrafico);

                let data = [
                    {
                        name: 'Empenhado',
                        x: empresasNomes,
                        y: valoresEmpenhados,
                        type: 'bar',
                        marker: { color: '#004080' }
                    },
                    {
                        name: 'A Empenhar',
                        x: empresasNomes,
                        y: valoresPendentes,
                        type: 'bar',
                        marker: { color: '#ff7f0e' }
                    }
                ];

                let layout = {
                    title: 'Comparativo de Empenhos por Empresa',
                    barmode: 'stack',
                    height: 500,
                    margin: { l: 50, r: 50, b: 150, t: 50, pad: 4 },
                    xaxis: {
                        tickangle: -45
                    },
                    yaxis: {
                        title: 'Valor (R$)'
                    },
                    legend: {
                        x: 0.1,
                        y: 1.1,
                        orientation: 'h'
                    }
                };

                Plotly.newPlot('grafico-geral', data, layout);
            }

            function criarGraficoEmpresa(empresa, index) {
                let empenhado = empresa.total_empenhado;
                let pendente = empresa.diferenca;
                let total = empresa.contrato_valor;
                let numContrato = empresa.numContrato || "N/A";
                let anoContrato = empresa.anoContrato || "N/A";

                // Criar div para o gráfico
                let divId = `grafico-empresa-${index}`;
                let divGrafico = document.createElement('div');
                divGrafico.className = 'empresa-card';
                divGrafico.dataset.id = empresa.identificador_unico || `contrato-${index}`;

                // Importante: Adicionando classe "contrato-clicavel" para facilitar a seleção
                divGrafico.classList.add('contrato-clicavel');

                let nomeEmpresa = truncarTexto(empresa.empresa, 40);

                let conteudo = `
            <h3>${nomeEmpresa}</h3>
            <div class="contrato-info"></div>
            <div class="empresa-dados">
                <p><strong>Valor Contratado:</strong> R$ ${formatarValor(total)}</p>
                <p><strong>Valor Empenhado:</strong> R$ ${formatarValor(empenhado)}</p>
                <p><strong>Valor Pendente:</strong> R$ ${formatarValor(pendente)}</p>
            </div>
            <div id="${divId}" class="grafico-empresa" data-id="${empresa.identificador_unico || `contrato-${index}`}"></div>
            <div class="contrato">
                <strong><br>Contrato:</strong> 
                ${(() => {
                        if (empresa.sem_contrato) return '<span class="badge sem-contrato">Sem Contrato</span>';
                        if (empresa.contrato_incompleto) return `<span class="badge contrato-incompleto">${numContrato}/${anoContrato} (Info. incompleta)</span>`;
                        return `<span class="badge contrato-normal">${numContrato}/${anoContrato}</span>`;
                    })()}
            </div>
        `;

                divGrafico.innerHTML = conteudo;
                $("#graficos-container").append(divGrafico);

                // Criar o gráfico
                let data = [
                    {
                        labels: ['Empenhado', 'A Empenhar'],
                        values: [empenhado, pendente > 0 ? pendente : 0], // Evitar valores negativos
                        type: 'pie',
                        marker: {
                            colors: ['#004080', '#ff7f0e']
                        },
                        textinfo: 'percent',
                        insidetextorientation: 'radial'
                    }
                ];

                let layout = {
                    height: 250,
                    width: 250,
                    margin: { l: 10, r: 10, b: 10, t: 10, pad: 0 },
                    showlegend: true,
                    legend: { orientation: 'h' }
                };

                Plotly.newPlot(divId, data, layout);

                // Armazenar a referência da empresa no elemento para uso no evento
                divGrafico.empresaData = empresa;

                // Aplicar evento de clique diretamente ao divGrafico
                $(divGrafico).on('click', function () {
                    mostrarModalContrato(this.empresaData);
                });
            }

            // Função para exibir o modal com detalhes do contrato
            function mostrarModalContrato(contrato) {
                console.log("Abrindo modal para:", contrato); // Log para debug

                const modal = document.getElementById('contrato-modal');
                const modalBody = modal.querySelector('.modal-body');
                const modalTitle = modal.querySelector('.modal-title');

                // Definir o título do modal
                modalTitle.textContent = `Contrato: ${contrato.empresa}`;

                // Preparar o conteúdo do modal
                let conteudoModal = '';

                // Informações gerais do contrato
                conteudoModal += `
            <div class="info-group">
                <h4>Informações Gerais</h4>
                <div class="info-item">
                    <span class="info-label">Empresa:</span> ${contrato.empresa || 'Não informado'}
                </div>
                <div class="info-item">
                    <span class="info-label">Código da Empresa:</span> ${contrato.detalhes_contrato.codEmpresa || 'Não informado'}
                </div>
                <div class="info-item">
                    <span class="info-label">Ano do Contrato:</span> ${contrato.anoContrato || 'Não informado'}
                </div>
                <div class="info-item">
                    <span class="info-label">Número do Contrato:</span> ${contrato.numContrato || 'Não informado'}
                </div>
                <div class="info-item">
                    <span class="info-label">Valor Total Contratado:</span> R$ ${formatarValor(contrato.total_contratos)}
                </div>
                <div class="info-item">
                    <span class="info-label">Valor Empenhado:</span> R$ ${formatarValor(contrato.total_empenhado)}
                </div>
                <div class="info-item">
                    <span class="info-label">Valor a Empenhar:</span> R$ ${formatarValor(contrato.diferenca)}
                </div>
                <div class="info-item">
                    <span class="info-label">Valor do Reajuste:</span> R$ ${formatarValor(contrato.detalhes_contrato?.valReajustes || 0)}
                </div>
                <div class="info-item">
                    <span class="info-label">Quantidade de Empenhos:</span> ${contrato.quantidade_empenhos || 0}
                </div>
            </div>`;

                // Detalhes específicos do contrato
                if (contrato.detalhes_contrato) {
                    conteudoModal += `
                <div class="info-group">
                    <h4>Detalhes do Contrato</h4>`;

                    // Verificar se é um contrato sem contrato
                    if (contrato.sem_contrato) {
                        conteudoModal += `
                    <div class="info-item">
                        <span class="info-label">Tipo:</span> Empenho sem contrato formal
                    </div>`;
                    } else {
                        // Adicionar modalidade
                        if (contrato.detalhes_contrato.modalidade) {
                            conteudoModal += `
                        <div class="info-item">
                            <span class="info-label">Modalidade:</span> ${contrato.detalhes_contrato.modalidade}
                        </div>`;
                        }
                        if (contrato.detalhes_contrato.codModalidade) {
                            conteudoModal += `
                            <div class="info-item">
                                <span class="info-label">Código da Modalidade:</span> ${contrato.detalhes_contrato.codModalidade}
                                </div>`;
                        }
                        if (contrato.detalhes_contrato.tipoContratacao) {
                            conteudoModal += `
                            <div class="info-item">
                                <span class="info-label">Tipo de Contratação:</span> ${contrato.detalhes_contrato.tipoContratacao}
                                </div>`;
                        }
                        if (contrato.detalhes_contrato.codTipoContratacao) {
                            conteudoModal += `
                        <div class="info-item">
                            <span class="info-label">Código do Tipo de Contratação:</span> ${contrato.detalhes_contrato.codTipoContratacao}
                        </div>`;
                        }
                        if (contrato.detalhes_contrato.codigoProcesso) {
                            conteudoModal += `
                                <div class="info-item">
                                    <span class="info-label">Código do Processo:</span> ${contrato.detalhes_contrato.codigoProcesso}
                                </div>`;
                        }
                        if (contrato.detalhes_contrato.objetoContrato) {
                            conteudoModal += `
                        <div class="info-item">
                            <span class="info-label">Objeto do Contrato:</span> ${contrato.detalhes_contrato.objetoContrato}
                        </div>`;
                        }
                        if (contrato.detalhes_contrato.datVigencia) {
                            conteudoModal += `
                        <div class="info-item">
                            <span class="info-label">Data de Vigência:</span> ${contrato.detalhes_contrato.datVigencia}
                        </div>`;
                        }
                        if (contrato.detalhes_contrato.codOrgao) {
                            conteudoModal += `
                        <div class="info-item">
                            <span class="info-label">Código do Orgão:</span> ${contrato.detalhes_contrato.codOrgao}
                        </div>`;
                        }
                        if (contrato.detalhes_contrato.txtDescricaoOrgao) {
                            conteudoModal += `
                        <div class="info-item">
                            <span class="info-label">Descrição do Orgão:</span> ${contrato.detalhes_contrato.txtDescricaoOrgao}
                        </div>`;
                        }

                    }

                    conteudoModal += `</div>`;
                }

                // Inserir o conteúdo no modal
                modalBody.innerHTML = conteudoModal;

                // Exibir o modal
                modal.style.display = 'block';
            }

            // Adicionar delegação de eventos para os cartões de empresa (melhor performance)
            $(document).on('click', '.contrato-clicavel', function () {
                mostrarModalContrato($(this).prop('empresaData'));
            });

            // Fechar o modal quando o usuário clicar no X
            $('.close-modal').on('click', function () {
                $('#contrato-modal').hide();
            });

            // Fechar o modal se o usuário clicar fora dele
            $(window).on('click', function (event) {
                const modal = document.getElementById('contrato-modal');
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });

            function formatarValor(valor) {
                if (valor === undefined || valor === null) return '0,00';
                return parseFloat(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            function truncarTexto(texto, maxLength) {
                if (!texto) return "Sem nome";
                if (texto.length > maxLength) {
                    return texto.substring(0, maxLength) + '...';
                }
                return texto;
            }
        });
    </script>
</body>

</html>